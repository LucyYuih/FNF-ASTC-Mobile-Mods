<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mobile ASTC Mods [OPT]</title>
<style>
:root{
  --bg:#0b0f14;
  --muted:#97a0ac;
  --accent:#7c5cf7;
  --glass: rgba(255,255,255,0.03);
  --radius:14px;
  --gap:18px;

  --cols: 3;
  --card-scale: 1;
  --title-size: calc(15px * var(--card-scale));
  --meta-size: calc(12px * var(--card-scale));
  --btn-font: calc(13px * var(--card-scale));
  --btn-padding-vert: calc(8px * var(--card-scale));
  --btn-padding-horiz: calc(10px * var(--card-scale));
  --thumb-aspect: 16 / 9;
}

/* reset / base */
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#07090c 0%, #0b0f14 100%);color:#e6eef8;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto,Arial;overflow-x:hidden;}
.app{max-width:1200px;margin:28px auto;padding:20px;}
header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;}
.brand{display:flex;gap:12px;align-items:center;}
.square{width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent),#4bb6ff);font-weight:800;color:#06111a;font-size:20px;}
.titleWrap{display:flex;flex-direction:column;}
.titleWrap h1{font-size:18px;margin:0}
.titleWrap .lead{margin:0;color:var(--muted);font-size:13px}
.controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
.search{background:var(--glass);padding:10px 12px;border-radius:999px;display:flex;gap:8px;align-items:center;min-width:160px;max-width:420px;}
.search input{background:transparent;border:0;color:inherit;outline:none;font-size:14px;width:100%;min-width:0;}

/* sort selector */
.sort-wrap{display:flex;align-items:center;gap:8px;margin-left:8px}
.sort-select{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:10px;color:inherit;font-weight:600}

/* tabs */
.tabs{display:flex;gap:8px;padding:12px 0;margin-bottom:12px;align-items:center;flex-wrap:wrap;}
.tab-group{display:flex;gap:8px;flex:1;align-items:center;flex-wrap:wrap;}
.tab{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:12px;color:var(--muted);cursor:pointer;font-weight:600;font-size:13px;}
.tab.active{background:linear-gradient(90deg, rgba(124,92,247,0.12), rgba(75,182,255,0.06));border-color:transparent;color:#e9f0ff;box-shadow:0 6px 20px rgba(16,18,22,0.4)}
.tab.requests-tab{margin-left:auto;background:linear-gradient(90deg,#4bb6ff,#7c5cf7);color:#06111a;border:0;box-shadow:0 8px 30px rgba(75,182,255,0.12);}

/* grid: responsive columns via --cols; use minmax(0,1fr) so columns shrink */
.grid{
  display:grid;
  gap:var(--gap);
  grid-template-columns: repeat(var(--cols), minmax(0, 1fr));
  align-items:start;
  overflow:auto;
  padding-bottom:6px;
  transition:all 0.18s ease;
  width:100%;
}

/* CARD */
.card{
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
  padding:calc(12px * var(--card-scale));
  border-radius:var(--radius);
  display:flex;
  flex-direction:column;
  gap:calc(10px * var(--card-scale));
  border:1px solid rgba(255,255,255,0.03);
  transition:transform 0.18s ease;
}

/* thumb */
.thumb{
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  background:linear-gradient(135deg,#07101a,#0b1420);
  box-shadow:inset 0 -20px 40px rgba(0,0,0,0.35);
  aspect-ratio: var(--thumb-aspect);
  width:100%;
  min-height:60px;
}
.thumb img{width:100%;height:100%;object-fit:cover;display:block;transition: opacity 0.25s ease;}

/* scaled text & buttons inside cards */
.card .title{font-size:var(--title-size);margin:0;color:#eaf2ff;font-weight:700;line-height:1.15}
.card .meta{font-size:var(--meta-size);color:var(--muted);display:block;margin-top:-2px}

/* global button style */
.btn{
  flex:0 0 auto;
  padding:8px 10px;
  border-radius:10px;
  border:0;
  background:transparent;
  color:#cfe3ff;
  font-weight:700;
  font-size:13px;
  cursor:pointer;
  border:1px solid rgba(255,255,255,0.04);
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-height:32px;
}

/* buttons inside cards: equal width */
.card .btn{
  flex:1 1 0;
  padding: var(--btn-padding-vert) var(--btn-padding-horiz);
  font-size: var(--btn-font);
  min-height: calc(32px * var(--card-scale));
  min-width: 0;
}

/* variants */
.btn.primary{background:linear-gradient(90deg,var(--accent),#4bb6ff);color:#06111a;box-shadow:0 8px 30px rgba(124,92,247,0.12);border:0}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03)}
.btn.small{padding:6px 8px;font-size:12px;border-radius:8px}
.extra-buttons{display:flex;gap:6px;flex-wrap:wrap;flex:1 1 100%}
.card .buttons { display:flex; gap:8px; align-items:center; flex-wrap:wrap; width:100%; }

/* options */
.options-container { position: relative; margin-left: auto; }
.options-menu { display: none; position: absolute; top: 110%; right: 0; background: var(--glass); backdrop-filter: blur(8px); border-radius: 10px; padding: 12px; min-width: 160px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); z-index: 20; }
.options-menu.show { display: flex; align-items: center; gap: 12px; }
.options-menu input[type=range]{ -webkit-appearance: none; appearance: none; width:140px; height:8px; background: linear-gradient(90deg,#2b3340,#111418); border-radius:6px; outline:none; }
.options-menu input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; width:20px;height:20px;border-radius:50%;background:linear-gradient(90deg,var(--accent),#4bb6ff);box-shadow:0 6px 18px rgba(0,0,0,0.4); }
.options-menu input[type=range]::-moz-range-thumb{ width:20px;height:20px;border-radius:50%;background:linear-gradient(90deg,var(--accent),#4bb6ff);border:0; }
.cols-count{ background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); padding:6px 10px; border-radius:8px; font-weight:800; color:#eaf2ff; min-width:38px; text-align:center; font-size:14px; }

/* requests */
.request-form { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.03)); border-radius: var(--radius); padding: 20px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 24px; display: none; }
.form-group { margin-bottom: 16px; }
.form-control { width:100%; padding:10px 12px; background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.05); border-radius:10px; color:#eaf2ff; }
.requests-grid { display: grid; gap: var(--gap); grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
.request-card { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); padding: 16px; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.03); position: relative; box-shadow: 0 4px 18px rgba(0,0,0,0.35); }
.request-title{font-size:16px;margin:8px 0;font-weight:700;color:#eaf2ff}
.request-meta { color: var(--muted); font-size:13px; margin-bottom: 10px; display:flex; gap:12px; align-items:center; }
.request-category { display:inline-block; padding:4px 10px; background: rgba(124,92,247,0.1); border-radius:6px; color:#c6b3ff; font-weight:700; font-size:13px;}
.request-body{font-size:14px;color:#d0d8e3;line-height:1.4;margin-bottom:8px}
.request-status { position:absolute; top:16px; right:16px; font-size:11px; padding:6px 8px; border-radius:6px; font-weight:700; }
.request-tabs { display:flex; gap:8px; margin:12px 0; }
.request-tab { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:8px 12px; border-radius:10px; background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); font-weight:700; cursor:pointer; font-size:13px; }
.request-tab.active { background: linear-gradient(90deg, rgba(124,92,247,0.14), rgba(75,182,255,0.08)); color:#eaf2ff; border:0; box-shadow:0 8px 20px rgba(0,0,0,0.35); }
.request-view-tab { display:inline-flex; align-items:center; justify-content:center; gap:6px; padding:10px 16px; border-radius:12px; background:transparent; border:1px solid rgba(255,255,255,0.08); color:var(--muted); font-weight:700; cursor:pointer; font-size:14px; transition: all 0.2s ease; }
.request-view-tab.active { background: linear-gradient(90deg, rgba(124,92,247,0.18), rgba(75,182,255,0.12)); color:#eaf2ff; border:0; box-shadow:0 10px 25px rgba(0,0,0,0.4); transform: translateY(-1px); }
.status-open { background: rgba(46, 204, 113, 0.12); color: #2ecc71; border:1px solid rgba(46,204,113,0.08) }
.status-closed { background: rgba(231, 76, 60, 0.12); color: #e74c3c; border:1px solid rgba(231,76,60,0.08) }
.request-link { color: #7c5cf7; text-decoration:none; font-weight:700 }

/* spinner */
.thumb .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.footer{color:var(--muted);font-size:12px;margin-top:14px;text-align:center}

/* ------------------------------
   Modal warning styles (desktop/Edge tuned)
   ------------------------------ */
#siteWarningModalOverlay{
  position:fixed;
  inset:0;
  background:rgba(2,6,12,0.7);
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
  -webkit-overflow-scrolling: touch;
  overflow:auto;
}
#siteWarningModal{
  background:linear-gradient(180deg, #0f1720 0%, #07101a 100%);
  border-radius:12px;
  max-width:900px;
  width:100%;
  color:#eaf2ff;
  box-shadow:0 24px 60px rgba(2,6,12,0.8);
  border:1px solid rgba(255,255,255,0.04);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  max-height: calc(100vh - 80px);
}
#siteWarningModal header{
  padding:18px 20px;
  border-bottom:1px solid rgba(255,255,255,0.03);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex: 0 0 auto;
}
#siteWarningModal header h3{margin:0;font-size:18px}
#siteWarningModal .modal-body{
  padding:18px 20px;
  display:flex;
  gap:18px;
  flex-direction:column;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  flex: 1 1 auto;
  max-height: calc(100vh - 160px);
}
#siteWarningModal .warning-text{font-size:14px;color:#ffd6d6;background:rgba(231,76,60,0.06);padding:10px;border-radius:8px;border:1px solid rgba(231,76,60,0.08)}
#siteWarningModal .hint{font-size:13px;color:var(--muted)}
#siteWarningModal video{max-width:100%;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#000;max-height:60vh;height:auto}
#siteWarningModal .modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:14px 20px;border-top:1px solid rgba(255,255,255,0.02)}
#siteWarningModal .modal-actions .btn{min-width:120px}
#siteWarningModal .learn-more{font-size:13px;color:var(--muted);text-decoration:underline;cursor:pointer}

/* small screens: stack video below text */
@media (min-width:720px){
  #siteWarningModal .modal-body{flex-direction:row;align-items:flex-start}
  #siteWarningModal .modal-col{flex:1}
  #siteWarningModal .modal-video{flex:1;max-width:420px}
}
@media (max-width:719px){
  #siteWarningModal{max-width:480px; max-height: 100vh;}
  #siteWarningModal .modal-body{max-height: calc(100vh - 120px);}
}
</style>
</head>
<body>
  <div class="app">

    <!-- WARNING MODAL (ADDED) -->
    <div id="siteWarningModalOverlay" style="display:none;" aria-hidden="true">
      <div id="siteWarningModal" role="dialog" aria-modal="true" aria-labelledby="siteWarningTitle">
        <header>
          <h3 id="siteWarningTitle">Important Notice — Safety</h3>
          <button id="siteWarningClose" class="btn ghost" type="button" aria-label="Close notice">Close</button>
        </header>
        <div class="modal-body">
          <div class="modal-col">
            <div class="warning-text">
              Please <strong>do not download anything from outside the website <span style="color:#7c5cf7;">ranoz.gg</span></strong> — files from external sources may contain unwanted or malicious content. Always prefer links hosted on <strong>ranoz.gg</strong> listed on this site.
            </div>
            <p class="hint" style="margin-top:10px;">
              If you're having trouble downloading or installing, watch the tutorial video on the right — it is located in the same folder as this page.
            </p>
          </div>

          <div class="modal-col modal-video" style="display:flex;flex-direction:column;gap:8px;align-items:stretch">
            <!-- Make sure 'tutorial.mp4' is in same folder as index.html -->
            <video id="siteTutorialVideo" controls preload="metadata" poster="" tabindex="0">
              <source src="tutorial.mp4" type="video/mp4">
              Your browser does not support HTML5 video — open the file tutorial.mp4 in the same folder.
            </video>
            <div style="display:flex;justify-content:flex-end;align-items:center;">
              <button id="siteWarningGotIt" class="btn primary" type="button">Got it</button>
              <button id="siteWarningDontShow" class="btn ghost" type="button" style="margin-left:8px;">Don’t show again</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- END WARNING MODAL -->

    <header>
      <div class="brand">
        <div class="square">FNF</div>
        <div class="titleWrap">
          <h1>Mobile ASTC Mods [OPT]</h1>
          <div class="lead">Optimized Mods for Mobile</div>
        </div>
      </div>

      <div class="controls">
        <div style="display:flex;align-items:center">
          <div class="search" title="Search by name">
            🔎 <input id="search" placeholder="Search by name..." />
          </div>
          <div class="sort-wrap">
            <label for="sortSelect" style="font-size:13px;color:var(--muted)">Sort:</label>
            <select id="sortSelect" class="sort-select" title="Sort mods">
              <option value="default">Default</option>
              <option value="alpha">Alphabetical</option>
              <option value="recent">Most Recent Added</option>
            </select>
          </div>
        </div>

        <div class="options-container">
          <button id="optionsBtn" class="btn ghost" type="button">⚙ Options</button>
          <div id="optionsMenu" class="options-menu" aria-hidden="true">
            <input type="range" id="zoomSlider" min="1" max="8" step="1" />
            <div class="cols-count" id="colsCount">3</div>
          </div>
        </div>
      </div>
    </header>

    <nav class="tabs" id="tabs">
      <div class="tab-group" id="tabGroup">
        <button class="tab active" data-cat="all" type="button">All</button>
        <button class="tab" data-cat="Tools" type="button">Tools</button>
        <button class="tab" data-cat="Skins" type="button">Skins</button>
        <button class="tab" data-cat="Mods" type="button">Mods</button>
      </div>
      <button class="tab requests-tab" data-cat="requests" id="requestsTab" type="button">Requests</button>
    </nav>

    <main>
      <section id="grid" class="grid" aria-live="polite"></section>
      
      <!-- Request Section -->
      <section id="requestSection" style="display: none;">
        <form class="request-form" id="requestForm" novalidate>
          <h2>Request a Mod/Skin/Tool</h2>
          <p style="margin-bottom: 16px; color: var(--muted);">Submit your request for a new mod, skin or tool to be added to the collection (requires GitHub login).</p>
          
          <!-- GitHub Login Section -->
          <div id="githubLoginSection" style="margin-bottom: 20px; padding: 16px; background: rgba(255,255,255,0.02); border-radius: 10px; border: 1px solid rgba(255,255,255,0.05);">
            <div id="loginForm" style="display: block;">
              <h3 style="margin: 0 0 12px 0; color: #eaf2ff; font-size: 16px;">GitHub Authentication</h3>
              <p style="margin: 0 0 16px 0; color: var(--muted); font-size: 14px;">Login with your GitHub Personal Access Token to submit and manage requests</p>
              
              <div class="form-group" style="margin-bottom: 12px;">
                <label for="githubUsername" style="display: block; margin-bottom: 6px; color: #eaf2ff; font-weight: 600; font-size: 13px;">GitHub Username*</label>
                <input type="text" id="githubUsernameInput" class="form-control" placeholder="your-github-username" required>
              </div>
              
              <div class="form-group" style="margin-bottom: 16px;">
                <label for="githubToken" style="display: block; margin-bottom: 6px; color: #eaf2ff; font-weight: 600; font-size: 13px;">Personal Access Token*</label>
                <input type="password" id="githubTokenInput" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" required>
                <small style="display: block; margin-top: 4px; color: var(--muted); font-size: 12px;">
                  <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--accent); text-decoration: none;">Create a token</a> with 'repo' and 'user' scopes
                </small>
              </div>
              
              <div style="display: flex; gap: 10px; align-items: center;">
                <button id="githubLoginBtn" class="btn primary" type="button">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 6px;">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                  </svg>
                  Login
                </button>
                <div id="loginSpinner" style="display: none;">
                  <div class="spinner" style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.1); border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </div>
              </div>
              
              <div id="loginError" style="display: none; margin-top: 12px; padding: 10px; background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.2); border-radius: 6px; color: #e74c3c; font-size: 13px;"></div>
            </div>
            
            <div id="loginSuccess" style="display: none;">
              <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <img id="userAvatar" src="" alt="Avatar" style="width: 32px; height: 32px; border-radius: 50%; display: none;">
                  <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center;" id="defaultAvatar">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                  </div>
                  <div>
                    <p style="margin: 0; color: #2ecc71; font-weight: 700; font-size: 14px;">Logged in as <span id="githubUsername"></span></p>
                    <p style="margin: 0; color: var(--muted); font-size: 12px;">You can now submit and manage requests</p>
                  </div>
                </div>
                <button id="githubLogoutBtn" class="btn ghost small" type="button">Logout</button>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="requestTitle">Title*</label>
            <input type="text" id="requestTitle" class="form-control" placeholder="Name of the mod, skin, etc." required>
          </div>
          <div class="form-group">
            <label for="requestCategory">Category*</label>
            <select id="requestCategory" class="form-control" required>
              <option value="">Select a category</option>
              <option value="Mods">Mods</option>
              <option value="Skins">Skins</option>
              <option value="Tools">Tools</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="requestLink">Link*</label>
            <input type="url" id="requestLink" class="form-control" placeholder="https://..." required>
            <small style="display: block; margin-top: 4px; color: var(--muted);">Where can we find this mod?</small>
          </div>
          <div class="form-group">
            <label for="requestDescription">Description</label>
            <textarea id="requestDescription" class="form-control" rows="4" placeholder="Provide any additional details..."></textarea>
          </div>
          <div class="form-actions" style="display:flex;gap:8px;align-items:center;">
            <button id="submitRequest" class="btn primary" type="button">Submit Request</button>
            <a href="https://github.com/LucyYuih/FNF-ASTC-Mobile-Mods/issues" target="_blank" class="btn ghost">View All Requests</a>
          </div>
        </form>

        <div class="request-divider" style="height:18px;"></div>
        
        <h2>Requests</h2>
        
        <!-- Request View Tabs (All/My) -->
        <div class="request-view-tabs" style="display: flex; gap: 8px; margin: 12px 0;">
          <button class="request-view-tab active" id="allRequestsViewTab" type="button">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 6px;">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            All Requests
          </button>
          <button class="request-view-tab" id="myRequestsViewTab" style="display: none;" type="button">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 6px;">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            My Requests
          </button>
        </div>
        
        <!-- Status Filter Tabs (Open/Closed) -->
        <div class="request-tabs" role="tablist" aria-label="Request status tabs" style="margin-bottom:12px;">
          <button class="request-tab active" id="openRequestsTab" type="button">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 4px;">
              <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            Open
          </button>
          <button class="request-tab" id="closedRequestsTab" type="button">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 4px;">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
            Closed
          </button>
        </div>
        
        <p id="requestsDescription" style="margin-bottom: 16px; color: var(--muted);">Recent requests from the community.</p>
        <div class="requests-grid" id="requestsGrid"></div>
      </section>
    </main>

    <div class="footer">@LucyYuih</div>
  </div>

<script>
/* ========== constants & preserved logic ========== */
const GITHUB_BLOB = 'https://github.com/LucyYuih/FNF-ASTC-Mobile-Mods/blob/main/mods.txt';
const REPO = 'LucyYuih/FNF-ASTC-Mobile-Mods';
const ISSUES_API = `https://api.github.com/repos/${REPO}/issues`;
const CORS_PROXY = 'https://corsproxy.io/?';

let thumbnailObserver = null;
window._originalOrderTitles = null;

/* --- Routing / state-in-url additions
   Behavior:
   - We store current tab and sort in the URL.
   - On GitHub Pages (hostname includes "github.io") we use hash routing (safe).
   - Otherwise we prefer pretty paths (history.pushState) when available.
   - On load we read hash first (if present), else pathname.
   - Programmatic navigation updates URL accordingly.
*/
const useHashRouting = (function(){
  // If served from GitHub Pages (github.io) or file protocol, prefer hash routing to avoid 404 on refresh.
  try {
    if (location.protocol === 'file:') return true;
    const host = (location.hostname || '').toLowerCase();
    if (host.includes('github.io')) return true;
  } catch(e){}
  return false;
})();

let suppressUrlUpdate = false;

function getActiveTab() {
  const active = document.querySelector('.tab.active');
  return (active && active.dataset && active.dataset.cat) ? active.dataset.cat : 'all';
}

function buildStatePath(tab, sort) {
  tab = (tab || 'all').toString().toLowerCase();
  sort = (sort || 'default').toString().toLowerCase();
  if (tab === 'requests') {
    return `/${encodeURIComponent(tab)}`;
  }
  if (!sort || sort === 'default') {
    return `/${encodeURIComponent(tab)}`;
  }
  return `/${encodeURIComponent(tab)}/${encodeURIComponent(sort)}`;
}

function parseStateFromHash(hash) {
  if (!hash) return null;
  // allow '#/skins/recent' or '#skins/recent' or '#!/skins/recent'
  const cleaned = hash.replace(/^#(!)?/, '');
  if (!cleaned) return null;
  const parts = cleaned.replace(/^\/+|\/+$/g,'').split('/');
  const tab = parts[0] || 'all';
  const sort = parts[1] || 'default';
  return { tab: decodeURIComponent(tab), sort: decodeURIComponent(sort) };
}

function parseStateFromPathname(path) {
  if (!path) return null;
  const p = path.split('?')[0].split('#')[0];
  const clean = p.replace(/^\/+|\/+$/g,''); // remove leading/trailing slashes
  if (!clean) return { tab: 'all', sort: 'default' };
  const parts = clean.split('/');
  // If the repo is served under a subdirectory (e.g., /owner/repo/...), try to detect known base.
  // We keep it simple: if first segment looks like 'requests' or a tab name, use it.
  const candidate = parts[0].toLowerCase();
  if (['requests','all','skins','mods','tools'].includes(candidate)) {
    const tab = candidate;
    const sort = (parts[1] || 'default').toLowerCase();
    return { tab, sort };
  }
  // fallback: return null so caller can ignore
  return null;
}

function readStateFromLocation() {
  // prefer hash (explicit)
  const fromHash = parseStateFromHash(location.hash);
  if (fromHash) return fromHash;
  const fromPath = parseStateFromPathname(location.pathname);
  if (fromPath) return fromPath;
  return { tab: 'all', sort: 'default' };
}

function updateUrlState(tab, sort) {
  try {
    tab = (tab || 'all').toString().toLowerCase();
    sort = (sort || 'default').toString().toLowerCase();

    const path = buildStatePath(tab, sort);
    if (useHashRouting) {
      // use hash routing (safe for GitHub Pages)
      const hash = '#' + path;
      // only change if different
      if (location.hash !== hash) {
        history.replaceState(null, '', location.pathname + hash);
      }
    } else {
      // prefer pretty paths; replaceState so no navigation occurs
      // but DO NOT set hash to avoid duplicate weirdness on some servers
      const newUrl = path;
      if (location.pathname !== newUrl || location.search !== '') {
        history.replaceState(null, '', newUrl + location.search + location.hash);
      }
    }
  } catch (e) {
    // ignore
    console.warn('updateUrlState failed', e);
  }
}

/* DOM ready */
document.addEventListener('DOMContentLoaded', ()=> {
  const raw = blobToRaw(GITHUB_BLOB);
  loadFromUrl(raw).then(() => {
    // once mods are loaded and grid rendered, restore UI state from URL
    try { restoreStateFromLocation(); } catch(e){ console.warn('restoreStateFromLocation error', e); }
  });
  loadRequests();

  // wire controls (preserve existing function names)
  const sortSelect = document.getElementById('sortSelect');
  if (sortSelect) {
    // replaced: call applySortAndReorder and update URL (unless suppressed)
    sortSelect.addEventListener('change', () => {
      applySortAndReorder();
      if (!suppressUrlUpdate) {
        updateUrlState(getActiveTab(), sortSelect.value);
      }
    });
  }

  const zoomSlider = document.getElementById('zoomSlider');
  const colsCount = document.getElementById('colsCount');
  if (zoomSlider) {
    zoomSlider.addEventListener('input', e => {
      applyColumns(e.target.value);
      colsCount.textContent = e.target.value;
    });
  }

  const optionsBtn = document.getElementById('optionsBtn');
  const optionsMenu = document.getElementById('optionsMenu');
  if (optionsBtn) {
    optionsBtn.addEventListener('click', ()=> {
      const isVisible = optionsMenu.classList.contains('show');
      if (isVisible) {
        optionsMenu.classList.remove('show');
        optionsMenu.setAttribute('aria-hidden', 'true');
      } else {
        optionsMenu.classList.add('show');
        optionsMenu.setAttribute('aria-hidden', 'false');
      }
    });
  }
  document.addEventListener('click', (e) => {
    if (optionsMenu && !optionsMenu.contains(e.target) && !optionsBtn.contains(e.target)) {
      optionsMenu.classList.remove('show');
      optionsMenu.setAttribute('aria-hidden', 'true');
    }
  });

  // init saved columns & numeric display
  const savedCols = parseInt(localStorage.getItem('gridColumns') || getComputedStyle(document.documentElement).getPropertyValue('--cols') || 3, 10);
  const slider = document.getElementById('zoomSlider');
  if (slider) slider.value = Math.min(8, Math.max(1, savedCols));
  document.getElementById('colsCount').textContent = slider ? slider.value : 3;
  applyColumns(slider ? slider.value : 3);

  // wire tab clicks (single listener)
  const tabs = document.getElementById('tabs');
  if (tabs) {
    tabs.addEventListener('click', (e) => {
      const b = e.target.closest('.tab');
      if(!b) return;
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const category = b.dataset.cat;
      if (category === 'requests') {
        document.getElementById('grid').style.display = 'none';
        document.getElementById('requestSection').style.display = 'block';
        document.getElementById('requestForm').style.display = 'block';
        loadRequests();
      } else {
        document.getElementById('grid').style.display = 'grid';
        document.getElementById('requestSection').style.display = 'none';
        filterAndShow();
      }

      // update URL to reflect active tab (and current sort)
      try {
        const currentSort = (document.getElementById('sortSelect') && document.getElementById('sortSelect').value) ? document.getElementById('sortSelect').value : 'default';
        updateUrlState(category, currentSort);
      } catch(e){}

    });
  }

  // wire request view tabs/buttons safely (all buttons are type="button" to avoid native form validation)
  const allView = document.getElementById('allRequestsViewTab');
  const myView = document.getElementById('myRequestsViewTab');
  const openTab = document.getElementById('openRequestsTab');
  const closedTab = document.getElementById('closedRequestsTab');
  if (allView) allView.addEventListener('click', () => switchRequestView('all'));
  if (myView) myView.addEventListener('click', () => switchRequestView('my'));
  if (openTab) openTab.addEventListener('click', () => switchRequestStatus('open'));
  if (closedTab) closedTab.addEventListener('click', () => switchRequestStatus('closed'));

  // wire submit + login buttons
  document.getElementById('submitRequest').addEventListener('click', submitRequest);
  document.getElementById('githubLoginBtn').addEventListener('click', async () => {
    const username = document.getElementById('githubUsernameInput').value.trim();
    const token = document.getElementById('githubTokenInput').value.trim();

    if (!username || !token) {
      showLoginError('Please enter both username and token');
      return;
    }
    await authenticateWithGitHub(username, token);
  });

  document.getElementById('githubLogoutBtn').addEventListener('click', () => {
    githubToken = null;
    githubUser = null;
    localStorage.removeItem('github_token');
    localStorage.removeItem('github_user');
    updateLoginUI();
    document.getElementById('myRequestsViewTab').style.display = 'none';
    switchRequestView('all');
  });

  // listen to hashchange/popstate so browser back/forward restores state
  window.addEventListener('hashchange', () => { try { restoreStateFromLocation(); } catch(e){} });
  window.addEventListener('popstate', () => { try { restoreStateFromLocation(); } catch(e){} });

});

/* helper: convert blob -> raw */
function blobToRaw(blobUrl){
  try{
    const u = new URL(blobUrl);
    if(u.hostname.includes('github.com') && u.pathname.includes('/blob/')){
      const parts = u.pathname.split('/');
      const user = parts[1], repo = parts[2], branch = parts[4];
      const path = parts.slice(5).join('/');
      return `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${path}`;
    }
  }catch(e){}
  return blobUrl;
}

/* load mods.txt (preserved) */
async function loadFromUrl(url){
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const txt = await res.text();
    doParseAndRender(txt);
  }catch(err){
    console.warn('Fetch failed.', err);
  }
}

function doParseAndRender(txt){
  const items = parseModsTxt(txt);
  renderGrid(items);
}

/* parse functions (ADDED: Image link detection & image-url fallback) */
function parseModsTxt(txt){
  const lines = txt.split(/\r?\n/);
  let currentCategory = null;
  const items = []; let block = [];
  function flushBlock(){ if(block.length===0) return; const item=parseBlock(block,currentCategory); if(item) items.push(item); block=[]; }
  for(let i=0;i<lines.length;i++){
    const raw = lines[i];
    const line = raw.replace(/\u00A0/g,' ').trim();
    if(!line) continue;
    if(line.startsWith('#')) continue;
    const lower = line.toLowerCase();
    if(lower === 'tools' || lower === 'skins' || lower === 'mods'){ flushBlock(); currentCategory = capitalize(lower); continue; }
    if(/^[-]{3,}$/.test(line)) continue;
    if(line === '-') { flushBlock(); continue; }
    block.push(line);
  }
  flushBlock();
  return items;
}
function parseBlock(blockLines, currentCategory){
  const lines = blockLines.filter(l => l && l.trim() !== '');
  if(lines.length === 0) return null;
  const title = lines[0].trim();

  const urlRegex = /(https?:\/\/[^\s]+)/g;
  // Build array of {label, url}
  const links = [];
  // First pass: detect lines that are URLs and consider previous non-url line as label
  for (let i = 1; i < lines.length; i++) {
    const ln = lines[i].trim();
    const m = ln.match(urlRegex);
    if (m) {
      // try to use previous line as label if it exists and does not contain a URL
      let candidateLabel = null;
      if (i - 1 >= 1) {
        const prev = lines[i - 1].trim();
        if (!urlRegex.test(prev) && prev.toLowerCase() !== title.toLowerCase()) {
          candidateLabel = prev;
        }
      }
      for (const u of m) {
        links.push({ label: candidateLabel ? candidateLabel.trim() : null, url: u.replace(/[),.]+$/,'') });
        candidateLabel = null; // only use once
      }
    }
  }
  // fallback: collect any urls anywhere if no links found
  if (links.length === 0) {
    for (let i = 1; i < lines.length; i++) {
      const ln = lines[i].trim();
      const m = ln.match(urlRegex);
      if (m) for (const u of m) links.push({ label: null, url: u.replace(/[),.]+$/,'') });
    }
  }

  // build plain urls array (backwards compat)
  const urls = links.map(l => l.url);

  // *** New: detect Image link (explicit label "Image") or direct image urls and prefer them for thumb ***
  let imageUrl = null;
  try {
    // find labeled "Image"
    const labeledImage = links.find(l => l.label && String(l.label).trim().toLowerCase() === 'image' && l.url);
    if (labeledImage && labeledImage.url) imageUrl = labeledImage.url;
    // if not found, look for any link that ends with an image extension
    if (!imageUrl) {
      const imgCandidate = links.find(l => l.url && /\.(jpe?g|png|webp|gif|bmp|svg)(\?.*)?$/i.test(l.url));
      if (imgCandidate) imageUrl = imgCandidate.url;
    }
    // normalize protocol-relative urls
    if (imageUrl && imageUrl.startsWith('//')) imageUrl = 'https:' + imageUrl;
  } catch(e){
    imageUrl = null;
  }

  // choose candidateUrl with priority: GameBanana -> GameJolt -> first url
  let candidateUrl = null;
  if (urls.length > 0) {
    const gb = urls.find(u => /gamebanana\.com/i.test(u));
    const gj = urls.find(u => /gamejolt\.com/i.test(u));
    candidateUrl = gb || gj || urls[0] || null;
  }

  let category = currentCategory || 'Mods';
  if(!currentCategory){
    const joined = lines.join(' ').toLowerCase();
    if(joined.includes('skin')) category='Skins';
    else if(joined.includes('tool')||joined.includes('install')) category='Tools';
  }

  return { title, category, links, urls, candidateUrl, img: imageUrl || null, rawLines: lines };
}
function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }

/* makeCard (kept, but if item.img exists, use it directly as thumb) */
function makeCard(item){
  const el = document.createElement('div');
  el.className='card';
  el.dataset.title=item.title.toLowerCase();
  el.dataset.category=item.category;

  const thumb = document.createElement('div');
  thumb.className='thumb';

  // if item.img (detected Image link or direct image), use it immediately
  if (item.img) {
    const safeUrl = normalizeImageUrl(item.img);
    const img = document.createElement('img');
    img.src = safeUrl;
    img.alt = '';
    thumb.appendChild(img);
  } else {
    // otherwise, fallback to lazy fetch using candidateUrl
    if (item.candidateUrl) thumb.setAttribute('data-candidate-url', item.candidateUrl);
    const spinner = document.createElement('div');
    spinner.className = 'spinner';
    thumb.appendChild(spinner);
  }

  // Build sites list from item.urls (unique hostnames without www.)
  let hosts = [];
  try {
    hosts = Array.from(new Set((item.urls || []).map(u => {
      try {
        const h = new URL(u).hostname.replace(/^www\./i, '');
        return h;
      } catch (e) {
        // fallback: take first segment after protocol
        return String(u).replace(/^https?:\/\//i, '').split('/')[0];
      }
    }).filter(Boolean)));
  } catch (e) {
    hosts = [];
  }
  const hostsText = hosts.length ? (' • ' + hosts.join(', ')) : '';

  const title = document.createElement('div');
  // append the sitesText after the link count as requested
  const metaText = `${escapeHtml(item.category)} • ${item.urls.length} link(s)${escapeHtml(hostsText)}`;
  title.innerHTML = `<div class="title">${escapeHtml(item.title)}</div><div class="meta">${metaText}</div>`;

  const buttons = document.createElement('div');
  buttons.className='buttons';

  if(item.urls.length>0){
    const aDl=document.createElement('a');
    aDl.className='btn primary';
    aDl.href=item.urls[0];
    aDl.target='_blank';
    aDl.rel='noopener';
    aDl.textContent='Download';
    buttons.appendChild(aDl);

    const aOrig=document.createElement('a');
    aOrig.className='btn ghost';
    aOrig.href=item.urls[item.urls.length-1];
    aOrig.target='_blank';
    aOrig.rel='noopener';
    aOrig.textContent='Original';
    buttons.appendChild(aOrig);

    if(item.links && item.links.length > 2){
      for(let i=1;i<item.links.length-1;i++){
        const linkObj = item.links[i];
        const ext=document.createElement('a');
        ext.className='btn ghost';
        ext.href = linkObj.url;
        ext.target = '_blank';
        ext.rel = 'noopener';
        ext.textContent = linkObj.label ? linkObj.label : `Link ${i+1}`;
        buttons.appendChild(ext);
      }
    }
  } else {
    const no=document.createElement('div');
    no.className='btn ghost';
    no.textContent='No link';
    buttons.appendChild(no);
  }

  el.appendChild(thumb);
  el.appendChild(title);
  el.appendChild(buttons);

  return el;
}

/* normalize image urls slightly (protocol-relative) */
function normalizeImageUrl(u){
  if(!u) return u;
  u = String(u).trim();
  if(u.startsWith('//')) return 'https:' + u;
  return u;
}

/* renderGrid and store original order */
function renderGrid(items){
  const grid=document.getElementById('grid');
  grid.innerHTML='';
  window.currentItems=items;
  const frag=document.createDocumentFragment();

  for(const it of items)
    frag.appendChild(makeCard(it));

  grid.appendChild(frag);
  filterAndShow();

  window._originalOrderTitles = Array.from(grid.children).map(c => c.dataset.title || '');

  setupThumbnailObserver();
}

/* thumbs observer */
function setupThumbnailObserver() {
  try {
    if (!thumbnailObserver) {
      thumbnailObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const thumb = entry.target;
            const candidateUrl = thumb.getAttribute('data-candidate-url');
            if (candidateUrl) {
              observer.unobserve(thumb);
              loadThumbnail(thumb, candidateUrl);
            }
          }
        });
      }, {
        rootMargin: '0px 0px 200px 0px'
      });
    }
    // observe any thumbs with candidate urls
    document.querySelectorAll('.thumb[data-candidate-url]').forEach(thumb => {
      try { thumbnailObserver.observe(thumb); } catch(e){}
    });
  } catch(e) {
    console.warn('setupThumbnailObserver error', e);
  }
}

/* loadThumbnail (unchanged behavior but robust) */
async function loadThumbnail(thumbElement, candidateUrl) {
  try {
    const imgUrl = await fetchImageUrl(candidateUrl);
    if (imgUrl) {
      thumbElement.innerHTML = '';
      const img = document.createElement('img');
      img.src = imgUrl;
      img.alt = '';
      thumbElement.appendChild(img);
    } else {
      // fallback placeholder
      thumbElement.innerHTML = '';
      const placeholder=document.createElement('div');
      placeholder.style.width='100%';
      placeholder.style.height='100%';
      placeholder.style.display='flex';
      placeholder.style.alignItems='center';
      placeholder.style.justifyContent='center';
      placeholder.style.fontWeight='800';
      placeholder.style.fontSize='28px';
      placeholder.style.color='#eaf2ff';
      const card = thumbElement.closest('.card');
      if (card && card.dataset.title) {
        const title = card.dataset.title;
        const cleanTitle = title.replace(/^[\[\(]+/,'').trim();
        placeholder.textContent = (cleanTitle.slice(0,2) || 'M').toUpperCase();
      } else {
        placeholder.textContent = 'M';
      }
      thumbElement.appendChild(placeholder);
    }
    thumbElement.removeAttribute('data-candidate-url');
  } catch (error) {
    console.warn('Failed to load thumbnail for', candidateUrl, error);
    thumbElement.innerHTML = '';
    const placeholder=document.createElement('div');
    placeholder.style.width='100%';
    placeholder.style.height='100%';
    placeholder.style.display='flex';
    placeholder.style.alignItems='center';
    placeholder.style.justifyContent='center';
    placeholder.style.fontWeight='800';
    placeholder.style.fontSize='28px';
    placeholder.style.color='#eaf2ff';
    const card = thumbElement.closest('.card');
    if (card && card.dataset.title) {
      const title = card.dataset.title;
      const cleanTitle = title.replace(/^[\[\(]+/,'').trim();
      placeholder.textContent = (cleanTitle.slice(0,2) || 'M').toUpperCase();
    } else {
      placeholder.textContent = 'M';
    }
    thumbElement.appendChild(placeholder);
    thumbElement.removeAttribute('data-candidate-url');
  }
}

/* fetchImageUrl: try to extract og:image or first big image */
async function fetchImageUrl(url) {
  try {
    // use CORS proxy (same as before)
    const resp = await fetch(CORS_PROXY + encodeURIComponent(url));
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const html = await resp.text();
    const doc = new DOMParser().parseFromString(html, 'text/html');

    // prefer og:image (common)
    const og = doc.querySelector('meta[property="og:image"], meta[name="og:image"]');
    if (og && og.content) {
      let img = og.content;
      if (img.startsWith('/')) img = new URL(img, url).href;
      return img;
    }

    // fallback: look for first large-ish image on page
    const imgs = Array.from(doc.querySelectorAll('img'))
      .map(i => i.getAttribute('src') || i.getAttribute('data-src') || i.getAttribute('data-original'))
      .filter(Boolean)
      .map(src => {
        if (src.startsWith('http')) return src;
        if (src.startsWith('//')) return 'https:' + src;
        if (src.startsWith('/')) return new URL(src, url).href;
        return null;
      })
      .filter(Boolean);

    if (imgs.length > 0) return imgs[0];

    return null;
  } catch (err) {
    console.warn('Thumb fetch failed for', url, err);
    return null;
  }
}

/* Requests (kept) */
let currentRequestView = 'all';
let currentRequestStatus = 'open';
let githubToken = localStorage.getItem('github_token');
let githubUser = null;

async function loadRequests() {
  try {
    let apiUrl = ISSUES_API;
    
    if (currentRequestStatus === 'closed') {
      apiUrl += '?state=closed';
    } else {
      apiUrl += '?state=open';
    }
    
    const response = await fetch(apiUrl);
    if (!response.ok) throw new Error('Failed to load requests');
    const issues = await response.json();
    
    let filteredIssues = issues.filter(issue => 
      !issue.pull_request && 
      issue.title.toLowerCase().includes('request:')
    );
    
    if (currentRequestView === 'my' && githubUser) {
      filteredIssues = filteredIssues.filter(issue => 
        issue.user.login === githubUser.login
      );
    }
    
    renderRequests(filteredIssues);
  } catch (error) {
    console.error('Error loading requests:', error);
    const rg = document.getElementById('requestsGrid');
    if (rg) rg.innerHTML = `<p style="color:var(--muted);">Failed to load requests. Please try again later.</p>`;
  }
}
function renderRequests(issues) {
  const container = document.getElementById('requestsGrid');
  container.innerHTML = '';
  
  if (issues.length === 0) {
    let message = 'No requests found.';
    if (currentRequestView === 'my') {
      message = currentRequestStatus === 'open' 
        ? 'You have no open requests. Submit your first request above!'
        : 'You have no closed requests.';
    } else {
      message = currentRequestStatus === 'open'
        ? 'No open requests found. Be the first to submit one!'
        : 'No closed requests found.';
    }
    container.innerHTML = `<p style="color:var(--muted);text-align:center;padding:20px;">${message}</p>`;
    return;
  }
  
  const recentRequests = issues.slice(0, 12);
  recentRequests.forEach(issue => {
    const requestCard = document.createElement('div');
    requestCard.className = 'request-card';
    
    let category = 'Other';
    if (issue.labels && issue.labels.length > 0) {
      const categoryLabel = issue.labels.find(label => ['Mods', 'Skins', 'Tools'].includes(label.name));
      if (categoryLabel) category = categoryLabel.name;
    }
    
    const status = issue.state === 'open' ? 'open' : 'closed';
    const isMyRequest = githubUser && issue.user.login === githubUser.login;
    
    requestCard.innerHTML = `
      <div class="request-meta">
        <span class="request-category">${category}</span>
        <span>${formatDate(issue.created_at)}</span>
        ${isMyRequest ? '<span style="color: var(--accent); font-weight: 700; font-size: 11px;">YOUR REQUEST</span>' : ''}
      </div>
      <div class="request-status ${status === 'open' ? 'status-open' : 'status-closed'}">${status.toUpperCase()}</div>
      <h3 class="request-title">${escapeHtml(issue.title.replace('Request:', '').trim())}</h3>
      <div class="request-body">${truncateText(issue.body || 'No description provided', 240)}</div>
      <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 8px;">
        <span style="color: var(--muted); font-size: 12px;">by ${issue.user.login}</span>
        <a href="${issue.html_url}" target="_blank" class="request-link">View on GitHub →</a>
      </div>
    `;
    container.appendChild(requestCard);
  });
}

/* submitRequest (kept) */
async function submitRequest() {
  if (!githubUser || !githubToken) {
    alert('Please login with GitHub first to submit requests');
    return;
  }
  
  const title = document.getElementById('requestTitle').value.trim();
  const category = document.getElementById('requestCategory').value;
  const link = document.getElementById('requestLink').value.trim();
  const description = document.getElementById('requestDescription').value.trim();
  
  if (!title || !category || !link) {
    alert('Please fill in all required fields');
    return;
  }
  
  const submitBtn = document.getElementById('submitRequest');
  const originalText = submitBtn.textContent;
  
  try {
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    submitBtn.style.opacity = '0.6';
    
    const issueTitle = `Request: ${title}`;
    let issueBody = `**Category:** ${category}\n\n**Link:** ${link}\n\n`;
    if (description) {
      issueBody += `**Description:**\n${description}\n\n`;
    }
    issueBody += `_Submitted via ASTC Mobile Mods website by @${githubUser.login}_`;
    
    const response = await fetch(`https://api.github.com/repos/${REPO}/issues`, {
      method: 'POST',
      headers: {
        'Authorization': `token ${githubToken}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        title: issueTitle,
        body: issueBody,
        labels: ['Request', category]
      })
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.message || 'Failed to submit request');
    }
    
    const newIssue = await response.json();
    
    document.getElementById('requestForm').reset();
    alert('Request submitted successfully! It will appear in the requests list shortly.');
    loadRequests();
    
  } catch (error) {
    console.error('Error submitting request:', error);
    alert('Failed to submit request: ' + error.message);
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
    submitBtn.style.opacity = '1';
  }
}

/* filter/search (kept) */
const searchInput = document.getElementById('search');
if (searchInput) searchInput.addEventListener('input', filterAndShow);
function filterAndShow(){
  if (document.getElementById('requestSection').style.display === 'block') return;
  const q=document.getElementById('search').value.trim().toLowerCase();
  const active=document.querySelector('.tab.active')?.dataset?.cat||'all';
  const grid=document.getElementById('grid');
  const cards=Array.from(grid.children);
  for(const c of cards){
    const title=(c.dataset.title||'').toLowerCase();
    const cat=(c.dataset.category||'').toLowerCase();
    const matchQ = !q || title.includes(q);
    const matchCat = active==='all' || cat === (active||'').toLowerCase();
    c.style.display = (matchQ && matchCat) ? '' : 'none';
  }
  setupThumbnailObserver();
}

function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ---------- applyColumns ---------- */
function applyColumns(cols) {
  cols = Math.max(1, Math.min(8, Number(cols) || 3));
  document.documentElement.style.setProperty('--cols', cols);
  let scale = 1 - (cols - 1) * 0.07;
  if (scale < 0.58) scale = 0.58;
  if (scale > 1) scale = 1;
  document.documentElement.style.setProperty('--card-scale', scale.toString());
  localStorage.setItem('gridColumns', String(cols));
}

/* sorting (kept) */
function applySortAndReorder() {
  const sortSelect = document.getElementById('sortSelect');
  const mode = sortSelect ? sortSelect.value : 'default';
  const grid = document.getElementById('grid');
  const cards = Array.from(grid.children);
  if (cards.length === 0) return;

  const original = window._originalOrderTitles || cards.map(c => c.dataset.title || '');
  const originalIndex = {};
  original.forEach((t,i) => originalIndex[t] = i);

  let sorted = cards.slice();

  if (mode === 'default') {
    sorted.sort((a,b) => {
      const ta = a.dataset.title || '';
      const tb = b.dataset.title || '';
      const ia = originalIndex.hasOwnProperty(ta) ? originalIndex[ta] : Infinity;
      const ib = originalIndex.hasOwnProperty(tb) ? originalIndex[tb] : Infinity;
      return ia - ib;
    });
  } else if (mode === 'alpha') {
    sorted.sort((a,b)=> {
      const ta = (a.dataset.title||'').toLowerCase();
      const tb = (b.dataset.title||'').toLowerCase();
      if (ta === tb) {
        const ia = originalIndex[ta] || 0;
        const ib = originalIndex[tb] || 0;
        return ia - ib;
      }
      return ta.localeCompare(tb);
    });
  } else if (mode === 'recent') {
    sorted.sort((a,b) => {
      const ta = a.dataset.title || '';
      const tb = b.dataset.title || '';
      const ia = originalIndex.hasOwnProperty(ta) ? originalIndex[ta] : -Infinity;
      const ib = originalIndex.hasOwnProperty(tb) ? originalIndex[tb] : -Infinity;
      return ib - ia;
    });
  }

  for (const c of sorted) grid.appendChild(c);
  setupThumbnailObserver();
}

/* utilities */
function truncateText(text, maxLength) { if (!text) return ''; if (text.length <= maxLength) return escapeHtml(text); return escapeHtml(text.substring(0, maxLength)) + '...'; }
function formatDate(dateString) { const date = new Date(dateString); return date.toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' }); }

/* ========== GitHub Login + Requests JS (kept) ========== */
if (githubToken) {
  checkGitHubAuth();
}

async function authenticateWithGitHub(username, token) {
  showLoginSpinner(true);
  hideLoginError();
  
  try {
    const response = await fetch('https://api.github.com/user', {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (!response.ok) {
      throw new Error('Invalid token or authentication failed');
    }
    
    const userData = await response.json();
    
    if (userData.login.toLowerCase() !== username.toLowerCase()) {
      throw new Error('Username does not match the token owner');
    }
    
    githubToken = token;
    githubUser = userData;
    localStorage.setItem('github_token', token);
    localStorage.setItem('github_user', JSON.stringify(userData));
    
    updateLoginUI();
    const myTab = document.getElementById('myRequestsViewTab');
    if (myTab) myTab.style.display = 'inline-flex';
    loadRequests();
    
  } catch (error) {
    console.error('GitHub authentication error:', error);
    showLoginError(error.message || 'Authentication failed. Please check your credentials.');
  } finally {
    showLoginSpinner(false);
  }
}

async function checkGitHubAuth() {
  try {
    const storedUser = localStorage.getItem('github_user');
    if (storedUser && githubToken) {
      githubUser = JSON.parse(storedUser);
      const response = await fetch('https://api.github.com/user', {
        headers: {
          'Authorization': `token ${githubToken}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });
      
      if (response.ok) {
        updateLoginUI();
        const myTab = document.getElementById('myRequestsViewTab');
        if (myTab) myTab.style.display = 'inline-flex';
      } else {
        githubToken = null;
        githubUser = null;
        localStorage.removeItem('github_token');
        localStorage.removeItem('github_user');
      }
    }
  } catch (error) {
    console.error('Error checking GitHub auth:', error);
    githubToken = null;
    githubUser = null;
    localStorage.removeItem('github_token');
    localStorage.removeItem('github_user');
  }
}

function updateLoginUI() {
  const loginForm = document.getElementById('loginForm');
  const loginSuccess = document.getElementById('loginSuccess');
  const githubUsername = document.getElementById('githubUsername');
  const submitBtn = document.getElementById('submitRequest');
  const userAvatar = document.getElementById('userAvatar');
  const defaultAvatar = document.getElementById('defaultAvatar');

  if (githubUser && githubToken) {
    if (loginForm) loginForm.style.display = 'none';
    if (loginSuccess) loginSuccess.style.display = 'block';
    if (githubUsername) githubUsername.textContent = githubUser.login;
    
    if (githubUser.avatar_url && userAvatar) {
      userAvatar.src = githubUser.avatar_url;
      userAvatar.style.display = 'block';
      if (defaultAvatar) defaultAvatar.style.display = 'none';
    } else {
      if (userAvatar) userAvatar.style.display = 'none';
      if (defaultAvatar) defaultAvatar.style.display = 'flex';
    }
    
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.style.opacity = '1';
    }
  } else {
    if (loginForm) loginForm.style.display = 'block';
    if (loginSuccess) loginSuccess.style.display = 'none';
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.style.opacity = '0.5';
    }
    const u = document.getElementById('githubUsernameInput');
    const t = document.getElementById('githubTokenInput');
    if (u) u.value = '';
    if (t) t.value = '';
  }
}

function showLoginSpinner(show) {
  const spinner = document.getElementById('loginSpinner');
  const loginBtn = document.getElementById('githubLoginBtn');
  
  if (show) {
    if (spinner) spinner.style.display = 'block';
    if (loginBtn) { loginBtn.disabled = true; loginBtn.style.opacity = '0.6'; }
  } else {
    if (spinner) spinner.style.display = 'none';
    if (loginBtn) { loginBtn.disabled = false; loginBtn.style.opacity = '1'; }
  }
}

function showLoginError(message) {
  const errorDiv = document.getElementById('loginError');
  if (errorDiv) { errorDiv.textContent = message; errorDiv.style.display = 'block'; }
}
function hideLoginError() {
  const errorDiv = document.getElementById('loginError');
  if (errorDiv) errorDiv.style.display = 'none';
}

function switchRequestView(view) {
  currentRequestView = view;
  document.querySelectorAll('.request-view-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  if (view === 'all') {
    document.getElementById('allRequestsViewTab').classList.add('active');
    document.getElementById('requestsDescription').textContent = 'Recent requests from the community.';
  } else {
    document.getElementById('myRequestsViewTab').classList.add('active');
    document.getElementById('requestsDescription').textContent = 'Your submitted requests.';
  }
  loadRequests();
}

function switchRequestStatus(status) {
  currentRequestStatus = status;
  document.querySelectorAll('.request-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  if (status === 'open') {
    document.getElementById('openRequestsTab').classList.add('active');
  } else {
    document.getElementById('closedRequestsTab').classList.add('active');
  }
  loadRequests();
}

/* ------------------------------
   Modal behavior (UPDATED)
   ------------------------------ */
(function(){
  const overlay = document.getElementById('siteWarningModalOverlay');
  const modal = document.getElementById('siteWarningModal');
  const closeBtn = document.getElementById('siteWarningClose');
  const gotItBtn = document.getElementById('siteWarningGotIt');
  const dontShowBtn = document.getElementById('siteWarningDontShow');
  const storageKey = 'siteWarningDontShow_v1';

  function showModal(){
    if(!overlay) return;
    try {
      const dont = localStorage.getItem(storageKey);
      if (dont === 'true') return;
    } catch(e){}
    overlay.style.display = 'flex';
    overlay.setAttribute('aria-hidden','false');
    const video = document.getElementById('siteTutorialVideo');
    if(video) video.setAttribute('tabindex','0');
  }

  function hideModal(){
    if(!overlay) return;
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden','true');
    try { setupThumbnailObserver(); } catch(e){}
  }

  if(closeBtn) closeBtn.addEventListener('click', hideModal);
  if(gotItBtn) gotItBtn.addEventListener('click', hideModal);

  if(dontShowBtn) dontShowBtn.addEventListener('click', () => {
    try { localStorage.setItem(storageKey, 'true'); } catch(e){}
    hideModal();
  });

  if(overlay){
    overlay.addEventListener('click', (ev) => {
      if(ev.target === overlay) hideModal();
    });
  }

  document.addEventListener('keydown', (ev) => {
    if(ev.key === 'Escape') hideModal();
  });

  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(showModal, 150);
  });
})();
/* ------------------------------ */

/* ========= Routing helpers used after rendering ========= */
function navigateTo(tab, sort) {
  try {
    tab = (tab || 'all').toString();
    sort = (sort || 'default').toString();

    // find matching tab button
    const tabs = Array.from(document.querySelectorAll('.tab'));
    let target = tabs.find(t => (t.dataset && String(t.dataset.cat).toLowerCase() === tab.toLowerCase()));
    if (!target) {
      // try capitalized for ones like 'Skins'
      target = tabs.find(t => (t.dataset && String(t.dataset.cat).toLowerCase() === tab.toLowerCase()));
    }
    if (!target) {
      // default to 'all'
      target = document.querySelector('.tab[data-cat="all"]');
    }

    // switch active class without firing click side-effects
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    if (target) target.classList.add('active');

    // update UI
    if (target && target.dataset && target.dataset.cat === 'requests') {
      document.getElementById('grid').style.display = 'none';
      document.getElementById('requestSection').style.display = 'block';
      document.getElementById('requestForm').style.display = 'block';
      try { loadRequests(); } catch(e){}
    } else {
      document.getElementById('grid').style.display = 'grid';
      document.getElementById('requestSection').style.display = 'none';
      try { filterAndShow(); } catch(e){}
    }

    // set sort select without triggering URL update
    const sortEl = document.getElementById('sortSelect');
    if (sortEl) {
      suppressUrlUpdate = true;
      sortEl.value = sort;
      try { applySortAndReorder(); } catch(e){}
      suppressUrlUpdate = false;
    }

    // finally reflect in URL (single update)
    updateUrlState(tab, sort);
  } catch (e) {
    console.warn('navigateTo error', e);
  }
}

function restoreStateFromLocation() {
  const state = readStateFromLocation() || { tab: 'all', sort: 'default' };
  // ensure the UI is present before navigating
  navigateTo(state.tab, state.sort);
}

/* EOF */
</script>

</body>
</html>